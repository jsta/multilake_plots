---
title: "Viz of least and most compact lakes"
output: html_notebook
date: 2018-01-22
author: Nicole Smith
---
```{r setup, warning=FALSE}
library(tidyverse)
library(sf)
library(leaflet)

#lakes_poly <- st_read("D:/Continental_Limnology/Data_Working/LAGOS_US_Predecessors.gdb", "NHDWaterbody_LAGOS", stringsAsFactors = FALSE) %>%
#  filter(AreaHa >= 4) %>%
#  select(Permanent_Identifier, GNIS_Name, AreaSqKm, ReachCode, FType, FCode, STATE, lagoslakeid, Shape_Area, Shape_Length)
#save.image("C:/Users/smithn78/Dropbox/ContLimno Nicole/MyR/multilake_plots/lagos_lakes_4ha_select.RData")
load('lagos_lakes_4ha_select.RData')
```

I'll use the `multiplot` function from the [Cookbook for R](http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/) site with an [adaptation to add a title](http://www.guru-gis.net/multiplot-function-for-ggplot/).
```{r functions, echo=FALSE, warning=FALSE, message=FALSE}
## From R cookbook
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL, title="") {
  require(grid)
 
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
 
  numPlots = length(plots)
 
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
 
  if (nchar(title)>0){
    layout<-rbind(rep(0, ncol(layout)), layout)
  }
 
  if (numPlots==1) {
    print(plots[[1]])
 
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout), heights =if(nchar(title)>0){unit(c(0.5, rep(5,nrow(layout)-1)), "null")}else{unit(c(rep(5, nrow(layout))), "null")} )))
 
    # Make each plot, in the correct location
    if (nchar(title)>0){
      grid.text(title, vp = viewport(layout.pos.row = 1, layout.pos.col = 1:ncol(layout)))
    }
 
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
 
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

I'll be using the isoperimetric quotient, a common measure of compactness that compares the area of the shape to the area of a circle with the same perimeter. With this measure, a value of 1 indicates the lake is nearly circular, and lower values represent less compactness.
```{r}
lakes <- lakes_poly %>%
  mutate(compactness = (4*pi*Shape_Area)/(Shape_Length**2)) %>%
  arrange(-compactness) %>%
  mutate(compact_rank = row_number())
View(lakes)
```

Distribution of compactness.

```{r}
(hist <- ggplot(data=lakes, aes(x=compactness)) +
   geom_histogram(alpha = .5, fill = "blue") +
   geom_vline(aes(xintercept=median(compactness)))
)
```
Prepare a few subsets for plotting.
```{r}
most_compact_100 <- lakes %>%
  top_n(100, compact_rank)

least_compact_100 <- lakes %>%
  top_n(-100, compact_rank)

midpoint <- floor(nrow(lakes)/2)

mid_compact_100 <- lakes %>%
  filter(between(compact_rank, midpoint-50, midpoint+49))

```


```{r}
(m <- leaflet() %>%
   addProviderTiles(providers$Hydda.Base) %>%
   addCircleMarkers(data = top_100_centroids, radius = 4, fillOpacity = 1, stroke = FALSE) %>%
   addPolygons(data=top_100_lakes, weight = 2)
   )

```





```{r}
# Help from http://rstudio-pubs-static.s3.amazonaws.com/2852_379274d7c5734f979e106dcf019ec46c.html
plots <- list()
boxes <- list()

for (i in 1:nrow(plot_lakes)) {
  bbox <- st_bbox(plot_lakes[i,])
  boxes[[i]] <- bbox
}

x_max_range <- max(as.vector(sapply(boxes, function(x) x['xmax'] - x['xmin'])))
y_max_range <- max(as.vector(sapply(boxes, function(x) x['ymax'] - x['ymin'])))

max_dim <- max(y_max_range, x_max_range)

for (i in 1:nrow(plot_lakes)) {
 lake_to_plot <- plot_lakes[i,] %>% as("Spatial") %>% fortify(region = 'Permanent_Identifier')
 centroid <- plot_lakes[i,] %>% st_centroid() %>% st_coordinates()
 x_limits <- c(centroid[,'X'] + .5*max_dim, centroid[,'X'] - .5*max_dim)
 y_limits <- c(centroid[,'Y'] + .5*max_dim, centroid[,'Y'] - .5*max_dim)
 p1 <- ggplot(lake_to_plot) +
   geom_polygon(aes(x=long, y=lat, group=group), fill = NA, color = 'black') +
   theme_void() +
   coord_fixed() +
   xlim(x_limits) +
   ylim(y_limits)
 plots[[i]] <- p1
}

png(filename = "C:/Users/smithn78/Documents/Nicole temp/test_plot_lakes.png", width = 1920, height = 1200)
(mplot <- multiplot(plotlist = plots, cols = 10, title = "100 least compact lakes in LAGOS (not to scale)"))
dev.off()

svg("C:/Users/smithn78/Documents/Nicole temp/test_plot_lakes_2.svg", width = 14, height = 11)
mplot <- multiplot(plotlist = plots, cols = 10, title = "100 least compact lakes in LAGOS (not to scale)")
dev.off()

# ggplot(plot_lakes) +
#   geom_sf(aes(geometry = Shape), fill = 'white') +
#   theme_void()

```


```{r}
test <- plot_lakes %>%
  st_zm(drop=TRUE) %>%
  st_cast("POLYGON") %>%
  st_bbox()

glimpse(test)
```


```{r}
plot_lakes <- lakes_4ha %>%
  sample_n(100)
# Help from http://rstudio-pubs-static.s3.amazonaws.com/2852_379274d7c5734f979e106dcf019ec46c.html
plots <- list()
# boxes <- list()
# 
# for (i in 1:nrow(plot_lakes)) {
#   bbox <- st_bbox(plot_lakes[i,])
#   boxes[[i]] <- bbox
# }

# x_max_range <- max(as.vector(sapply(boxes, function(x) x['xmax'] - x['xmin'])))
# y_max_range <- max(as.vector(sapply(boxes, function(x) x['ymax'] - x['ymin'])))
# 
# max_dim <- max(y_max_range, x_max_range)

for (i in 1:nrow(plot_lakes)) {
 lake_to_plot <- plot_lakes[i,] %>% as("Spatial") %>% fortify(region = 'Permanent_Identifier')
 # centroid <- plot_lakes[i,] %>% st_centroid() %>% st_coordinates()
 # x_limits <- c(centroid[,'X'] + .5*max_dim, centroid[,'X'] - .5*max_dim)
 # y_limits <- c(centroid[,'Y'] + .5*max_dim, centroid[,'Y'] - .5*max_dim)
 p <- ggplot(lake_to_plot) +
   geom_polygon(aes(x=long, y=lat, group=group), fill = NA, color = 'black') +
   theme_void() +
   coord_fixed()
   # xlim(x_limits) +
   # ylim(y_limits)
 plots[[i]] <- p
}

png(filename = "C:/Users/smithn78/Dropbox/CL_HUB_GEO/Internal Maps/Lakes and Reservoirs Multiplots/sample_lakes_100.png", width = 1920, height = 1200)
(mplot <- multiplot(plotlist = plots, cols = 10, title = "100 random lakes in LAGOS (not to scale)"))
dev.off()


# ggplot(plot_lakes) +
#   geom_sf(aes(geometry = Shape), fill = 'white') +
#   theme_void()

```

